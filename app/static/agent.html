<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>FoodSales</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: radial-gradient(circle at 20% 20%, #eef3ff, #f7f9fc 55%);
      --panel: rgba(255, 255, 255, 0.9);
      --border: #e4e8f0;
      --shadow: 0 12px 35px rgba(37, 44, 97, 0.15);
      --text: #1f2a44;
      --muted: #56607a;
      --accent: #2563eb;
      --accent-2: #00b894;
      --danger: #e05252;
      --warning: #0ea5e9;
      --bubble-user: #e8f1ff;
      --bubble-bot: #f5f7fb;
      --radius: 14px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Manrope", "Segoe UI", sans-serif;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1.5rem 3rem;
      color: var(--text);
    }

    h1 {
      color: var(--text);
      margin-bottom: 1.25rem;
      letter-spacing: -0.5px;
      font-weight: 700;
    }

    #chat {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      width: min(720px, 100%);
      height: 460px;
      padding: 1.2rem;
      overflow-y: auto;
    }

    .msg {
      margin: 0.65rem 0;
      line-height: 1.5;
      display: flex;
      gap: 0.55rem;
      align-items: flex-start;
    }

    .bubble {
      padding: 0.65rem 0.9rem;
      border-radius: var(--radius);
      max-width: 90%;
      box-shadow: 0 6px 18px rgba(31, 42, 68, 0.05);
      border: 1px solid var(--border);
      background: var(--bubble-bot);
    }

    .user {
      justify-content: flex-end;
    }

    .user .bubble {
      background: var(--bubble-user);
      border-color: #d6e5ff;
    }

    .role {
      font-weight: 700;
      display: block;
      margin-bottom: 0.15rem;
    }

    #input-area {
      display: flex;
      width: min(720px, 100%);
      margin-top: 1rem;
      gap: 0.75rem;
      align-items: center;
    }

    input {
      flex: 1;
      padding: 0.9rem 1rem;
      border: 1px solid var(--border);
      border-radius: 12px;
      outline: none;
      font-size: 0.95rem;
      background: white;
      transition: border 0.2s, box-shadow 0.2s;
    }

    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }

    button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.85rem 1.1rem;
      border-radius: 12px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s;
      font-weight: 600;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.25);
    }

    button:hover {
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
    }

    .secondary {
      background: #6b7280;
      box-shadow: none;
    }

    .secondary:hover {
      background: #5a6070;
    }

    .danger {
      background: var(--danger);
      box-shadow: none;
    }

    .danger:hover {
      background: #cc4444;
    }

    .confirm {
      background: var(--accent-2);
      box-shadow: none;
    }

    .confirm:hover {
      background: #00a682;
    }

    .warning {
      background: var(--warning);
      box-shadow: none;
    }

    #quick-actions {
      margin-top: 0.85rem;
      width: min(720px, 100%);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 0.55rem;
      align-items: stretch;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      padding: 0.75rem 0.95rem;
      border-radius: 10px;
      font-size: 0.9rem;
      width: 100%;
    }

    .icon {
      font-size: 1rem;
    }
  </style>
</head>

<body>
  <h1>FoodSales</h1>

  <div id="chat"></div>

  <div id="input-area">
    <input id="msg" placeholder="Escribe algo...">
    <button onclick="send()">Enviar</button>
  </div>

  <div id="quick-actions">
    <button class="secondary pill" onclick="sendQuick('ver carrito')"><span class="icon">üõí</span>Ver carrito</button>
    <button class="danger pill" onclick="sendQuick('vac√≠a carrito')"><span class="icon">üßπ</span>Vaciar carrito</button>
    <button class="confirm pill" onclick="confirmOrder()"><span class="icon">‚úÖ</span>Confirmar pedido</button>
    <button class="secondary pill" onclick="viewOrders()"><span class="icon">üìë</span>Ver √≥rdenes</button>
    <button class="danger pill" onclick="escalateOrder()"><span class="icon">‚ö†Ô∏è</span>Escalar orden</button>
    <button class="warning pill" onclick="clearChat()"><span class="icon">üóëÔ∏è</span>Limpiar chat</button>
  </div>

  <script>
    const chat = document.getElementById("chat");
    const session_id = "cliente_011"; // se puede hacer dinamico mas adelante

    async function send() {
      const msg = document.getElementById("msg").value.trim();
      if (!msg) return;
      addMessage("user", msg);
      document.getElementById("msg").value = "";
      await sendToAgent(msg);
    }

    async function sendQuick(text) {
      addMessage("user", text);
      await sendToAgent(text);
    }

    let lastCart = { items: [] };

    async function sendToAgent(msg) {
      try {
        const res = await fetch("http://127.0.0.1:8000/chat/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: msg, session_id })
        });
        const data = await res.json();
        addMessage("bot", data.agent_response || "Sin respuesta.");

        // --- NUEVO: Capturar el carrito del summary estructurado ---
        if (data.summary && data.summary.cart) {
          lastCart = data.summary.cart;
          console.log("Carrito actualizado:", lastCart);
        }
      } catch (err) {
        addMessage("bot", "Error de conexion con el servidor.");
      }
    }

    async function confirmOrder() {
      try {
        addMessage("user", "Confirmar pedido");

        if (!lastCart || !lastCart.items || lastCart.items.length === 0) {
          addMessage("bot", "Tu carrito est√° vac√≠o. Agrega productos antes de confirmar.");
          return;
        }

        // Payload hacia /orders/ usando los datos estructurados
        const payload = {
          user_id: session_id,
          items: lastCart.items.map(i => ({
            nombre: i.name,
            cantidad: i.qty,
            precio_unitario: i.unit_price
          })),
          status: "pending"
        };

        const resOrder = await fetch("http://127.0.0.1:8000/orders/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const orderData = await resOrder.json();
        if (resOrder.ok) {
          addMessage("bot",
            `‚úÖ Pedido confirmado correctamente.<br>N√∫mero de orden: <b>${orderData.order_serial || orderData.order_id}</b><br>Total: ${payload.items.length} productos.`
          );
          // Limpiar el estado local
          lastCart = { items: [] };
        } else {
          addMessage("bot", "Error al procesar la orden: " + (orderData.detail || "Error desconocido"));
        }

      } catch (err) {
        console.error(err);
        addMessage("bot", "Error al confirmar pedido.");
      }
    }

    // Extrae productos del texto tipo "- Papa a la francesa x5 = $115,550 COP"
    function extractItemsFromText(text) {
      const lines = text.split("\n").filter(l => l.includes(" x"));
      return lines.map(line => {
        const match = line.match(/-\s*(.*?)\s*x(\d+)\s*=\s*\$([\d,]+)/);
        if (match) {
          return {
            nombre: match[1],
            cantidad: parseInt(match[2]),
            precio_unitario: parseInt(match[3].replace(/,/g, ""))
          };
        }
      }).filter(Boolean);
    }

    function addMessage(role, text) {
      const row = document.createElement("div");
      row.classList.add("msg", role);
      const bubble = document.createElement("div");
      bubble.classList.add("bubble");
      bubble.innerHTML = `<span class="role">${role === "user" ? "T√∫" : "Agente"}:</span>${text}`;
      row.appendChild(bubble);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
    }

    function clearChat() {
      const chatBox = document.getElementById("chat");
      chatBox.innerHTML = "";
      addMessage("bot", "Chat limpiado.");
    }

    async function fetchOrdersByUser() {
      const res = await fetch(`http://127.0.0.1:8000/orders/status?user_id=${session_id}`, {
        method: "GET"
      });
      return res.json();
    }

    async function viewOrders() {
      try {
        const data = await fetchOrdersByUser();
        const orders = data.orders || [];
        if (!orders.length) {
          addMessage("bot", "No hay √≥rdenes registradas para este usuario.");
          return;
        }
        const lines = orders.map(o => {
          const total = o.total?.toLocaleString("es-CO", { minimumFractionDigits: 0 });
          const created = o.created_at ? o.created_at : "";
          const itemsCount = Array.isArray(o.items) ? o.items.length : 0;
          return `- ${o.order_serial || o.id} | total: $${total} COP | items: ${itemsCount} | estado: ${o.status || "pendiente"} | fecha: ${created}`;
        });
        addMessage("bot", `√ìrdenes del usuario ${session_id}:\n` + lines.join("\n"));
      } catch (err) {
        addMessage("bot", "Error al consultar √≥rdenes.");
      }
    }

    async function escalateOrder() {
      try {
        const data = await fetchOrdersByUser();
        const ordersAll = data.orders || [];
        const orders = ordersAll.filter(o => (o.status || "").toLowerCase() !== "escalated");
        if (!orders.length) {
          addMessage("bot", "No hay √≥rdenes disponibles para escalar. Si ya escalaste, un asesor te contactar√° en menos de 24 horas.");
          return;
        }
        // Ordenar m√°s recientes primero
        orders.sort((a, b) => (b.id || 0) - (a.id || 0));

        // Construir opciones para elegir
        const options = orders.map((o, idx) => {
          const total = o.total?.toLocaleString("es-CO", { minimumFractionDigits: 0 }) ?? "0";
          return `${idx + 1}) ${o.order_serial || o.id} | $${total} COP | estado: ${o.status || "pendiente"}`;
        }).join("\n");

        const choice = prompt(`Elige la orden a escalar (1-${orders.length}):\n${options}`, "1");
        const index = choice ? parseInt(choice, 10) - 1 : 0;
        const selected = orders[index] || orders[0];

        const payload = {
          user_id: session_id,
          order_serial: selected.order_serial,
          motivo: "detalle"
        };
        const res = await fetch("http://127.0.0.1:8000/orders/escalate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const result = await res.json();
        if (result.should_escalate) {
          addMessage("bot", result.message || `Escalando la orden ${selected.order_serial || selected.id} a un asesor humano. Un asesor te contactar√° en menos de 24 horas.`);
        } else {
          addMessage("bot", result.message || "No se pudo escalar la orden.");
        }
      } catch (err) {
        addMessage("bot", "Error al escalar la orden.");
      }
    }

  </script>
</body>

</html>